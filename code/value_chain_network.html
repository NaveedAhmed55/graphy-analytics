<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Dashboard Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 80%;
        }

        .sidebar {
            width: 300px;
            padding: 20px;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .chart-container {
            flex-grow: 1;
            overflow: scroll;
            position: relative;
            width: 100%;
            height: 100%;
        }

        svg {
            width: 2000px;
            height: 1500px;
        }

        .node {
            stroke: black;
            stroke-width: 1px;
        }

        .status-optimal {
            fill: #2CA02C;
        }

        .status-underperforming {
            fill: #FF7F0E;
        }

        .status-not_present {
            fill: #FFFFFF;
        }

        .tooltip {
            position: absolute;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .tooltip table {
            width: 100%;
            margin-top: 5px;
            border-collapse: collapse;
        }

        .tooltip table, .tooltip th, .tooltip td {
            border: 1px solid #ddd;
            padding: 4px;
        }

        .tooltip th {
            background-color: #333;
            color: #fff;
        }

        .zoom-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .btn {
            margin: 5px;
        }

        .x-axis text, .y-axis text {
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            fill: #4a90e2;
        }

        .axis-label {
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            fill: #e94e77;
        }

        .x-axis path, .y-axis path,
        .x-axis line, .y-axis line {
            stroke: #e94e77;
            stroke-width: 2;
        }

        .details-section {
            padding: 20px;
            background-color: #ffffff;
            border-top: 1px solid #dee2e6;
            height: 20%;
            overflow-y: auto;
        }

        .details-section table {
            width: 100%;
            border-collapse: collapse;
        }

        .details-section th, .details-section td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .details-section th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <h4>Filters</h4>
            <div class="mb-3">
                <label for="statusFilter" class="form-label">Select Node Status:</label>
                <select id="statusFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="optimal">Optimal</option>
                    <option value="underperforming">Underperforming</option>
                    <option value="not_present">Not Present</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="knowledgeFilter" class="form-label">Select Knowledge Intensity:</label>
                <select id="knowledgeFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="capitalFilter" class="form-label">Select Capital Intensity:</label>
                <select id="capitalFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="laborFilter" class="form-label">Select Labor Intensity:</label>
                <select id="laborFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="naturalResourcesFilter" class="form-label">Select Natural Resources Intensity:</label>
                <select id="naturalResourcesFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <button id="resetFilters" class="btn btn-danger">Reset Filters</button>
            </div>

            <div class="mb-3">
                <input type="file" id="fileInputNodes" accept=".csv" class="form-control" />
                <label>Upload Nodes CSV</label>
            </div>
            <div class="mb-3">
                <input type="file" id="fileInputEdges" accept=".csv" class="form-control" />
                <label>Upload Edges CSV</label>
            </div>
        </div>

        <div class="chart-container">
            <div class="zoom-buttons">
                <button id="zoomIn" class="btn btn-primary btn-sm"><i class="fas fa-search-plus"></i> Zoom In</button>
                <button id="zoomOut" class="btn btn-secondary btn-sm"><i class="fas fa-search-minus"></i> Zoom Out</button>
            </div>
            <svg></svg>
        </div>
    </div>

    <div class="details-section" id="detailsSection">
        <h4>Node Details</h4>
        <table id="detailsTable"></table>
    </div>

    <script>
        const svg = d3.select("svg"),
              margin = {top: 50, right: 50, bottom: 50, left: 50},
              width = 1800 - margin.left - margin.right,
              height = 1200 - margin.top - margin.bottom;

        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleLinear().domain([0, 100]).range([0, width]);
        const y = d3.scaleLinear().domain([0, 100]).range([height, 0]);

        let nodesData, edgesData;
        let currentZoom = 1;
        let currentTransform = d3.zoomIdentity;

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        document.getElementById('fileInputNodes').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                nodesData = d3.csvParse(e.target.result).map(d => ({
                    ...d,
                    Value_Chain_Position: +d.Value_Chain_Position,
                    Global_Competition_Intensity: +d.Global_Competition_Intensity,
                    originalX: x(+d.Value_Chain_Position),
                    originalY: y(+d.Global_Competition_Intensity)
                }));
                if (edgesData) filterAndUpdate();
            };
            reader.readAsText(file);
        });

        document.getElementById('fileInputEdges').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                edgesData = d3.csvParse(e.target.result);
                if (nodesData) filterAndUpdate();
            };
            reader.readAsText(file);
        });

        d3.select('#statusFilter').on('change', filterAndUpdate);
        d3.select('#knowledgeFilter').on('change', filterAndUpdate);
        d3.select('#capitalFilter').on('change', filterAndUpdate);
        d3.select('#laborFilter').on('change', filterAndUpdate);
        d3.select('#naturalResourcesFilter').on('change', filterAndUpdate);

        document.getElementById('zoomIn').addEventListener('click', () => zoomChart(1.2));
        document.getElementById('zoomOut').addEventListener('click', () => zoomChart(0.8));
        document.getElementById('resetFilters').addEventListener('click', resetFilters);

        function resetFilters() {
            d3.select("#statusFilter").property("value", "all");
            d3.select("#knowledgeFilter").property("value", "all");
            d3.select("#capitalFilter").property("value", "all");
            d3.select("#laborFilter").property("value", "all");
            d3.select("#naturalResourcesFilter").property("value", "all");

            filterAndUpdate();
        }

        const zoom = d3.zoom()
            .scaleExtent([0.5, 5])
            .translateExtent([[-width, -height], [2 * width, 2 * height]])
            .on("zoom", (event) => {
                currentTransform = event.transform;
                g.attr("transform", currentTransform);
            });

        svg.call(zoom);

        function zoomChart(factor) {
            currentZoom *= factor;
            svg.transition().duration(500).call(zoom.scaleTo, currentZoom);
        }

        function renderChart(nodes, edges) {
            g.selectAll("*").remove();

            if (nodes.length > 0) {
                x.domain([0, d3.max(nodes, d => d.Value_Chain_Position)]).nice();
                y.domain([0, d3.max(nodes, d => d.Global_Competition_Intensity)]).nice();
            }

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(10))
                .attr("class", "x-axis");

            g.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .attr("text-anchor", "middle")
                .attr("class", "axis-label")
                .text("Position in Value Chain (Upstream to Downstream)");

            g.append("g")
                .call(d3.axisLeft(y).ticks(10))
                .attr("class", "y-axis");

            g.append("text")
                .attr("x", -(height / 2))
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .text("Global Competition Intensity");

            edges.forEach(edge => {
                const sourceNode = nodes.find(n => n.Activity === edge.Source);
                const targetNode = nodes.find(n => n.Activity === edge.Target);

                if (sourceNode && targetNode) {
                    const { strokeWidth, strokeColor, lineDash } = getEdgeAttributes(edge);

                    g.append("line")
                        .attr("x1", x(sourceNode.Value_Chain_Position))
                        .attr("y1", y(sourceNode.Global_Competition_Intensity))
                        .attr("x2", x(targetNode.Value_Chain_Position))
                        .attr("y2", y(sourceNode.Global_Competition_Intensity))
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke", strokeColor)
                        .attr("stroke-dasharray", lineDash)
                        .on("mouseover", function(event) {
                            tooltip.transition().duration(200).style("opacity", .9);
                            tooltip.html(`
                                <strong>Edge Details</strong><br>
                                Source: ${edge.Source}<br>
                                Target: ${edge.Target}<br>
                                Type: ${edge.Edge_Type}
                            `)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.transition().duration(500).style("opacity", 0);
                        });

                    g.append("line")
                        .attr("x1", x(targetNode.Value_Chain_Position))
                        .attr("y1", y(sourceNode.Global_Competition_Intensity))
                        .attr("x2", x(targetNode.Value_Chain_Position))
                        .attr("y2", y(targetNode.Global_Competition_Intensity))
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke", strokeColor)
                        .attr("stroke-dasharray", lineDash)
                        .on("mouseover", function(event) {
                            tooltip.transition().duration(200).style("opacity", .9);
                            tooltip.html(`
                                <strong>Edge Details</strong><br>
                                Source: ${edge.Source}<br>
                                Target: ${edge.Target}<br>
                                Type: ${edge.Edge_Type}
                            `)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.transition().duration(500).style("opacity", 0);
                        });
                }
            });

            const node = g.selectAll(".node")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${x(d.Value_Chain_Position)},${y(d.Global_Competition_Intensity)})`)
                .on("click", function(event, d) {
                    displayNodeDetails(d);
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
                );

            node.append("rect")
                .attr("class", d => `status-${d.Status}`)
                .attr("width", 100)
                .attr("height", 50)
                .attr("x", -50)
                .attr("y", -25)
                .attr("fill", d => {
                    if (d.Status === 'optimal') {
                        return '#76c7c0';
                    } else if (d.Status === 'underperforming') {
                        return '#f47b20';
                    } else {
                        return '#f0e68c';
                    }
                })
                .attr("stroke", "#333")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`
                        <strong>Node Details</strong>
                        <table>
                            <tr><th>Attribute</th><th>Value</th></tr>
                            <tr><td>Activity</td><td>${d.Activity}</td></tr>
                            <tr><td>Status</td><td>${d.Status}</td></tr>
                            <tr><td>Knowledge Intensity</td><td>${d.Knowledge_Intensity}</td></tr>
                            <tr><td>Capital Intensity</td><td>${d.Capital_Intensity}</td></tr>
                            <tr><td>Labor Intensity</td><td>${d.Labor_Intensity}</td></tr>
                            <tr><td>Natural Resources Intensity</td><td>${d.Natural_Resources_Intensity}</td></tr>
                        </table>
                    `)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-0.4em")
                .attr("font-size", "14px")
                .attr("font-family", "'Open Sans', sans-serif")
                .attr("font-weight", "700")
                .attr("fill", "#333")
                .text(d => d.Activity)
                .call(wrapText, 90);

            const factors = ["Knowledge_Intensity", "Capital_Intensity", "Labor_Intensity", "Natural_Resources_Intensity"];
            const factorGroup = node.append("g").attr("transform", "translate(0, 10)");

            factors.forEach((factor, i) => {
                factorGroup.append("rect")
                    .attr("width", 24)
                    .attr("height", 11)
                    .attr("x", -50 + i * 25)
                    .attr("y", 15)
                    .attr("fill", d => getIntensityColor(d[factor]));

                factorGroup.append("text")
                    .attr("x", -40 + i * 25)
                    .attr("y", 22)
                    .attr("text-anchor", "middle")
                    .attr("fill", "black")
                    .attr("font-size", "8px")
                    .attr("font-family", "'Open Sans', sans-serif")
                    .text(factor.slice(0, 3).toLowerCase());
            });
        }

        function getEdgeAttributes(edge) {
            let strokeWidth, strokeColor, lineDash;
            switch (edge.Edge_Type) {
                case "Just in time":
                    strokeWidth = 2;
                    strokeColor = "grey";
                    lineDash = "none";
                    break;
                case "Made to order":
                    strokeWidth = 3;
                    strokeColor = "yellow";
                    lineDash = "5, 5";
                    break;
                default:
                    strokeWidth = 2;
                    strokeColor = "";
                    lineDash = "none";
                    break;
            }
            return { strokeWidth, strokeColor, lineDash };
        }

        function wrapText(text, width) {
            text.each(function() {
                const textElement = d3.select(this);
                const words = textElement.text().split(/\s+/).reverse();
                let word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1,
                    y = textElement.attr("y"),
                    dy = parseFloat(textElement.attr("dy") || 0),
                    tspan = textElement.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");

                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = textElement.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                    }
                }
            });
        }

        function filterAndUpdate() {
            const selectedStatus = d3.select("#statusFilter").property("value");
            const selectedKnowledge = d3.select("#knowledgeFilter").property("value");
            const selectedCapital = d3.select("#capitalFilter").property("value");
            const selectedLabor = d3.select("#laborFilter").property("value");
            const selectedNaturalResources = d3.select("#naturalResourcesFilter").property("value");

            let filteredNodes = nodesData;

            if (selectedStatus !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Status === selectedStatus);
            }

            if (selectedKnowledge !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Knowledge_Intensity === selectedKnowledge);
            }

            if (selectedCapital !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Capital_Intensity === selectedCapital);
            }

            if (selectedLabor !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Labor_Intensity === selectedLabor);
            }

            if (selectedNaturalResources !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Natural_Resources_Intensity === selectedNaturalResources);
            }

            const nodesWithEdges = new Set();
            edgesData.forEach(edge => {
                nodesWithEdges.add(edge.Source);
                nodesWithEdges.add(edge.Target);
            });

            filteredNodes = filteredNodes.filter(node => nodesWithEdges.has(node.Activity));

            renderChart(filteredNodes, edgesData);
        }

        function displayNodeDetails(nodeData) {
            const detailsTable = d3.select("#detailsTable");
            detailsTable.html("");

            const headers = Object.keys(nodeData);
            detailsTable.append("thead").append("tr")
                .selectAll("th")
                .data(headers)
                .enter()
                .append("th")
                .text(d => d);

            detailsTable.append("tbody").append("tr")
                .selectAll("td")
                .data(headers.map(header => nodeData[header]))
                .enter()
                .append("td")
                .text(d => d);
        }

        function getIntensityColor(value) {
            switch (value) {
                case "high":
                    return "#1f77b4";
                case "medium":
                    return "#ffdd57";
                case "low":
                    return "#d3d3d3";
                default:
                    return "#d3d3d3";
            }
        }

        function dragstarted(event, d) {
            d3.select(this).raise().attr("stroke", "black");
        }

        function dragged(event, d) {
            d3.select(this)
                .attr("transform", `translate(${event.x}, ${event.y})`);
        }

        function dragended(event, d) {
            d3.select(this)
                .attr("transform", `translate(${d.originalX}, ${d.originalY})`);
            d3.select(this).attr("stroke", null);
        }

    </script>
</body>
</html>
