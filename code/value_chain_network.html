<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Dashboard Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 80%;
        }

        .sidebar {
            width: 300px;
            padding: 20px;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .chart-container {
            flex-grow: 1;
            overflow: scroll;
            position: relative;
            width: 100%;
            height: 100%;
        }

        svg {
            width: 2000px;
            height: 1500px;
        }

        .node {
            stroke: black;
            stroke-width: 1px;
        }

        .status-optimal {
            fill: #2CA02C;
        }

        .status-underperforming {
            fill: #FF7F0E;
        }

        .status-not_present {
            fill: #FFFFFF;
        }

        .tooltip {
            position: absolute;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            border-radius: 8px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .zoom-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }

        .btn {
            margin: 5px;
        }

        .x-axis text, .y-axis text {
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            fill: #4a90e2;
        }

        .axis-label {
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            fill: #e94e77;
        }

        .x-axis path, .y-axis path,
        .x-axis line, .y-axis line {
            stroke: #e94e77;
            stroke-width: 2;
        }

        .details-section {
            padding: 20px;
            background-color: #ffffff;
            border-top: 1px solid #dee2e6;
            height: 20%;
            overflow-y: auto;
        }

        .details-section table {
            width: 100%;
            border-collapse: collapse;
        }

        .details-section th, .details-section td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .details-section th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <h4>Filters</h4>
            <div class="mb-3">
                <label for="statusFilter" class="form-label">Select Node Status:</label>
                <select id="statusFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="optimal">Optimal</option>
                    <option value="underperforming">Underperforming</option>
                    <option value="not_present">Not Present</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="knowledgeFilter" class="form-label">Select Knowledge Intensity:</label>
                <select id="knowledgeFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="capitalFilter" class="form-label">Select Capital Intensity:</label>
                <select id="capitalFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="laborFilter" class="form-label">Select Labor Intensity:</label>
                <select id="laborFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="naturalResourcesFilter" class="form-label">Select Natural Resources Intensity:</label>
                <select id="naturalResourcesFilter" class="form-select">
                    <option value="all">All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>

            <div class="mb-3">
                <button id="resetFilters" class="btn btn-danger">Reset Filters</button>
            </div>

            <div class="mb-3">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#nodeEdgeModal">Add Node/Edge</button>
            </div>

            <div class="mb-3">
                <button class="btn btn-primary" id="downloadNodes">Download Nodes CSV</button>
                <button class="btn btn-primary" id="downloadEdges">Download Edges CSV</button>
            </div>

            <div class="mb-3">
                <input type="file" id="fileInputNodes" accept=".csv" class="form-control" />
                <label>Upload Nodes CSV</label>
            </div>
            <div class="mb-3">
                <input type="file" id="fileInputEdges" accept=".csv" class="form-control" />
                <label>Upload Edges CSV</label>
            </div>
        </div>

        <div class="chart-container">
            <div class="zoom-buttons">
                <button id="zoomIn" class="btn btn-primary btn-sm"><i class="fas fa-search-plus"></i> Zoom In</button>
                <button id="zoomOut" class="btn btn-secondary btn-sm"><i class="fas fa-search-minus"></i> Zoom Out</button>
            </div>
            <svg></svg>
        </div>
    </div>

    <div class="details-section" id="detailsSection">
        <h4>Node Details</h4>
        <table id="detailsTable"></table>
    </div>

    <!-- Modal for adding and editing nodes and edges -->
    <div class="modal fade" id="nodeEdgeModal" tabindex="-1" aria-labelledby="nodeEdgeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeEdgeModalLabel">Add Node / Edge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="nodeEdgeForm">
                        <div class="mb-3">
                            <label for="addType" class="form-label">Add Type:</label>
                            <select id="addType" class="form-select">
                                <option value="node">Node</option>
                                <option value="edge">Edge</option>
                            </select>
                        </div>

                        <div id="nodeForm" class="mb-3">
                            <h6>Node Details</h6>
                            <label for="nodeName" class="form-label">Node Name</label>
                            <input type="text" id="nodeName" class="form-control" placeholder="Node Name">

                            <!-- Node-specific fields -->
                            <label for="nodeStatus" class="form-label">Status</label>
                            <select id="nodeStatus" class="form-select">
                                <option value="optimal">Optimal</option>
                                <option value="underperforming">Underperforming</option>
                                <option value="not_present">Not Present</option>
                            </select>

                            <label for="nodeKnowledge" class="form-label">Knowledge Intensity</label>
                            <select id="nodeKnowledge" class="form-select">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>

                            <label for="nodeCapital" class="form-label">Capital Intensity</label>
                            <select id="nodeCapital" class="form-select">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>

                            <label for="nodeLabor" class="form-label">Labor Intensity</label>
                            <select id="nodeLabor" class="form-select">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>

                            <label for="nodeNaturalResources" class="form-label">Natural Resources Intensity</label>
                            <select id="nodeNaturalResources" class="form-select">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>

                            <!-- Additional fields -->
                            <label for="nodeInstitution" class="form-label">Institution</label>
                            <input type="text" id="nodeInstitution" class="form-control" placeholder="Institution">

                            <label for="nodeLocation" class="form-label">Location</label>
                            <input type="text" id="nodeLocation" class="form-control" placeholder="Location">

                            <label for="nodeOwnership" class="form-label">Ownership/Funding</label>
                            <input type="text" id="nodeOwnership" class="form-control" placeholder="Ownership/Funding">

                            <label for="nodeVolume" class="form-label">Volume in Units</label>
                            <input type="number" id="nodeVolume" class="form-control" placeholder="Volume in Units">

                            <label for="nodeLaborRequirement" class="form-label">Labor Requirement & Status</label>
                            <input type="text" id="nodeLaborRequirement" class="form-control" placeholder="Labor Requirement">

                            <label for="nodeLinkagesSupport" class="form-label">Linkages with Support</label>
                            <input type="text" id="nodeLinkagesSupport" class="form-control" placeholder="Linkages with Other Support">

                            <label for="nodeLinkagesValueChain" class="form-label">Linkages with Value Chain</label>
                            <input type="text" id="nodeLinkagesValueChain" class="form-control" placeholder="Linkages with Value Chain Activities">

                            <label for="nodeLaunchingSchedule" class="form-label">Launching Schedule</label>
                            <input type="text" id="nodeLaunchingSchedule" class="form-control" placeholder="Launching Schedule">

                            <label for="nodeComments" class="form-label">Comments</label>
                            <input type="text" id="nodeComments" class="form-control" placeholder="Comments">

                            <!-- Random Columns -->
                            <label for="nodeRandom10" class="form-label">Random Column 10</label>
                            <input type="text" id="nodeRandom10" class="form-control" placeholder="Random Column 10">
                            
                            <label for="nodeRandom11" class="form-label">Random Column 11</label>
                            <input type="text" id="nodeRandom11" class="form-control" placeholder="Random Column 11">
                        </div>

                        <div id="edgeForm" class="mb-3" style="display: none;">
                            <h6>Edge Details</h6>
                            <label for="edgeSource" class="form-label">Source Node</label>
                            <input type="text" id="edgeSource" class="form-control" placeholder="Source">

                            <label for="edgeTarget" class="form-label">Target Node</label>
                            <input type="text" id="edgeTarget" class="form-control" placeholder="Target">

                            <label for="edgeType" class="form-label">Edge Type</label>
                            <select id="edgeType" class="form-select">
                                <option value="Just in time">Just in time</option>
                                <option value="Made to order">Made to order</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNodeEdgeButton">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        let currentEditData = null;
        let isEditingNode = false;
    
        const svg = d3.select("svg"),
              margin = {top: 50, right: 50, bottom: 50, left: 50},
              width = 1800 - margin.left - margin.right,
              height = 1200 - margin.top - margin.bottom;
    
        const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    
        const x = d3.scaleLinear().domain([0, 100]).range([0, width]);
        const y = d3.scaleLinear().domain([0, 100]).range([height, 0]);
    
        let nodesData = [], edgesData = [];
        let currentZoom = 1;
        let currentTransform = d3.zoomIdentity;
    
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    
        // Event Listeners for File Input, Zoom, Filters
        document.getElementById('fileInputNodes').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
    
            const reader = new FileReader();
            reader.onload = function(e) {
                nodesData = d3.csvParse(e.target.result).map(d => ({
                    ...d,
                    Value_Chain_Position: +d.Value_Chain_Position,
                    Global_Competition_Intensity: +d.Global_Competition_Intensity,
                    originalX: x(+d.Value_Chain_Position),
                    originalY: y(+d.Global_Competition_Intensity)
                }));
                if (edgesData) filterAndUpdate();
            };
            reader.readAsText(file);
        });
    
        document.getElementById('fileInputEdges').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
    
            const reader = new FileReader();
            reader.onload = function(e) {
                edgesData = d3.csvParse(e.target.result);
                if (nodesData) filterAndUpdate();
            };
            reader.readAsText(file);
        });
    
        d3.select('#statusFilter').on('change', filterAndUpdate);
        d3.select('#knowledgeFilter').on('change', filterAndUpdate);
        d3.select('#capitalFilter').on('change', filterAndUpdate);
        d3.select('#laborFilter').on('change', filterAndUpdate);
        d3.select('#naturalResourcesFilter').on('change', filterAndUpdate);
    
        document.getElementById('zoomIn').addEventListener('click', () => zoomChart(1.2));
        document.getElementById('zoomOut').addEventListener('click', () => zoomChart(0.8));
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
    
        function resetFilters() {
            d3.select("#statusFilter").property("value", "all");
            d3.select("#knowledgeFilter").property("value", "all");
            d3.select("#capitalFilter").property("value", "all");
            d3.select("#laborFilter").property("value", "all");
            d3.select("#naturalResourcesFilter").property("value", "all");
    
            filterAndUpdate();
        }
    
        const zoom = d3.zoom()
            .scaleExtent([0.5, 5])
            .translateExtent([[-width, -height], [2 * width, 2 * height]])
            .on("zoom", (event) => {
                currentTransform = event.transform;
                g.attr("transform", currentTransform);
            });
    
        svg.call(zoom);
    
        function zoomChart(factor) {
            currentZoom *= factor;
            svg.transition().duration(500).call(zoom.scaleTo, currentZoom);
        }
    
        // Dropdown Handling
        document.getElementById('addType').addEventListener('change', function() {
            const nodeForm = document.getElementById('nodeForm');
            const edgeForm = document.getElementById('edgeForm');
            
            if (this.value === 'node') {
                nodeForm.style.display = 'block';
                edgeForm.style.display = 'none';
            } else if (this.value === 'edge') {
                nodeForm.style.display = 'none';
                edgeForm.style.display = 'block';
            }
        });
    
        function renderChart(nodes, edges) {
            g.selectAll("*").remove();
    
            if (nodes.length > 0) {
                x.domain([0, d3.max(nodes, d => d.Value_Chain_Position)]).nice();
                y.domain([0, d3.max(nodes, d => d.Global_Competition_Intensity)]).nice();
            }
    
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(10))
                .attr("class", "x-axis");
    
            g.append("text")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .attr("text-anchor", "middle")
                .attr("class", "axis-label")
                .text("Position in Value Chain (Upstream to Downstream)");
    
            g.append("g")
                .call(d3.axisLeft(y).ticks(10))
                .attr("class", "y-axis");
    
            g.append("text")
                .attr("x", -(height / 2))
                .attr("y", -margin.left + 20)
                .attr("text-anchor", "middle")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .text("Global Competition Intensity");
    
            edges.forEach(edge => {
                const sourceNode = nodes.find(n => n.Activity === edge.Source);
                const targetNode = nodes.find(n => n.Activity === edge.Target);
    
                if (sourceNode && targetNode) {
                    const { strokeWidth, strokeColor, lineDash } = getEdgeAttributes(edge);
    
                    g.append("line")
                        .attr("x1", x(sourceNode.Value_Chain_Position))
                        .attr("y1", y(sourceNode.Global_Competition_Intensity))
                        .attr("x2", x(targetNode.Value_Chain_Position))
                        .attr("y2", y(sourceNode.Global_Competition_Intensity))
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke", strokeColor)
                        .attr("stroke-dasharray", lineDash)
                        .on("mouseover", function(event) {
                            tooltip.transition().duration(200).style("opacity", .9);
                            tooltip.html(`
                                <strong>Edge Details</strong><br>
                                Source: ${edge.Source}<br>
                                Target: ${edge.Target}<br>
                                Type: ${edge.Edge_Type}
                            `)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.transition().duration(500).style("opacity", 0);
                        });
    
                    g.append("line")
                        .attr("x1", x(targetNode.Value_Chain_Position))
                        .attr("y1", y(sourceNode.Global_Competition_Intensity))
                        .attr("x2", x(targetNode.Value_Chain_Position))
                        .attr("y2", y(targetNode.Global_Competition_Intensity))
                        .attr("stroke-width", strokeWidth)
                        .attr("stroke", strokeColor)
                        .attr("stroke-dasharray", lineDash)
                        .on("mouseover", function(event) {
                            tooltip.transition().duration(200).style("opacity", .9);
                            tooltip.html(`
                                <strong>Edge Details</strong><br>
                                Source: ${edge.Source}<br>
                                Target: ${edge.Target}<br>
                                Type: ${edge.Edge_Type}
                            `)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function() {
                            tooltip.transition().duration(500).style("opacity", 0);
                        });
                }
            });
    
            const node = g.selectAll(".node")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${x(d.Value_Chain_Position)},${y(d.Global_Competition_Intensity)})`)
                .on("click", function(event, d) {
                    displayNodeDetails(d);
                })
                .on("dblclick", function(event, d) {
                    editNode(d);
                })
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`
                        <strong>Node Details</strong><br>
                        Activity: ${d.Activity}<br>
                        Status: ${d.Status}<br>
                        Knowledge Intensity: ${d.Knowledge_Intensity}<br>
                        Capital Intensity: ${d.Capital_Intensity}<br>
                        Labor Intensity: ${d.Labor_Intensity}<br>
                        Natural Resources Intensity: ${d.Natural_Resources_Intensity}<br>
                        Institution: ${d.Institution}<br>
                        Location: ${d.Location}<br>
                        Ownership: ${d.Ownership}<br>
                        Volume: ${d.Volume}<br>
                        Labor Requirement: ${d.Labor_Requirement}<br>
                        Linkages with Support: ${d.Linkages_Support}<br>
                        Linkages with Value Chain: ${d.Linkages_Value_Chain}<br>
                        Launching Schedule: ${d.Launching_Schedule}<br>
                        Comments: ${d.Comments}<br>
                        Random_Column_10: ${d.Random_Column_10}<br>
                        Random_Column_11: ${d.Random_Column_11}
                    `)
                    .style("left", (event.pageX + 5) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().duration(500).style("opacity", 0);
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
                );
    
            node.append("rect")
                .attr("class", d => `status-${d.Status}`)
                .attr("width", 100)
                .attr("height", 50)
                .attr("x", -50)
                .attr("y", -25)
                .attr("fill", d => {
                    if (d.Status === 'optimal') {
                        return '#76c7c0';
                    } else if (d.Status === 'underperforming') {
                        return '#f47b20';
                    } else {
                        return '#f0e68c';
                    }
                })
                .attr("stroke", "#333")
                .attr("stroke-width", 2);
    
            node.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-0.4em")
                .attr("font-size", "14px")
                .attr("font-family", "'Open Sans', sans-serif")
                .attr("font-weight", "700")
                .attr("fill", "#333")
                .text(d => d.Activity)
                .call(wrapText, 90);
    
            // Add the small boxes below each node to represent the intensities
            const factors = ["Knowledge_Intensity", "Capital_Intensity", "Labor_Intensity", "Natural_Resources_Intensity"];
            const factorGroup = node.append("g").attr("transform", "translate(0, 10)");
    
            factors.forEach((factor, i) => {
                factorGroup.append("rect")
                    .attr("width", 24)
                    .attr("height", 11)
                    .attr("x", -50 + i * 25)
                    .attr("y", 15)
                    .attr("fill", d => getIntensityColor(d[factor]));
    
                factorGroup.append("text")
                    .attr("x", -40 + i * 25)
                    .attr("y", 22)
                    .attr("text-anchor", "middle")
                    .attr("fill", "black")
                    .attr("font-size", "8px")
                    .attr("font-family", "'Open Sans', sans-serif")
                    .text(factor.slice(0, 3).toLowerCase());
            });
        }
    
        // Dropdown event for Node/Edge selection and handling
        document.getElementById('addType').addEventListener('change', function() {
            const addType = document.getElementById('addType').value;
            if (addType === 'node') {
                document.getElementById('nodeForm').style.display = 'block';
                document.getElementById('edgeForm').style.display = 'none';
            } else if (addType === 'edge') {
                document.getElementById('nodeForm').style.display = 'none';
                document.getElementById('edgeForm').style.display = 'block';
            }
        });
    
        // Save node or edge
        document.getElementById('saveNodeEdgeButton').addEventListener('click', function() {
            const addType = document.getElementById('addType').value;
    
            if (addType === 'node') {
                const newNode = {
                    Activity: document.getElementById('nodeName').value,
                    Status: document.getElementById('nodeStatus').value,
                    Knowledge_Intensity: document.getElementById('nodeKnowledge').value,
                    Capital_Intensity: document.getElementById('nodeCapital').value,
                    Labor_Intensity: document.getElementById('nodeLabor').value,
                    Natural_Resources_Intensity: document.getElementById('nodeNaturalResources').value,
                    Institution: document.getElementById('nodeInstitution').value,
                    Location: document.getElementById('nodeLocation').value,
                    Ownership: document.getElementById('nodeOwnership').value,
                    Volume: document.getElementById('nodeVolume').value,
                    Labor_Requirement: document.getElementById('nodeLaborRequirement').value,
                    Linkages_Support: document.getElementById('nodeLinkagesSupport').value,
                    Linkages_Value_Chain: document.getElementById('nodeLinkagesValueChain').value,
                    Launching_Schedule: document.getElementById('nodeLaunchingSchedule').value,
                    Comments: document.getElementById('nodeComments').value,
                    Random_Column_10: document.getElementById('nodeRandom10').value,
                    Random_Column_11: document.getElementById('nodeRandom11').value,
                };
                nodesData.push(newNode);
            } else if (addType === 'edge') {
                const newEdge = {
                    Source: document.getElementById('edgeSource').value,
                    Target: document.getElementById('edgeTarget').value,
                    Edge_Type: document.getElementById('edgeType').value
                };
                edgesData.push(newEdge);
            }
    
            filterAndUpdate();
            const modal = bootstrap.Modal.getInstance(document.getElementById('nodeEdgeModal'));
            modal.hide();
        });
    
        function getEdgeAttributes(edge) {
            let strokeWidth, strokeColor, lineDash;
            switch (edge.Edge_Type) {
                case "Just in time":
                    strokeWidth = 2;
                    strokeColor = "grey";
                    lineDash = "none";
                    break;
                case "Made to order":
                    strokeWidth = 3;
                    strokeColor = "yellow";
                    lineDash = "5, 5";
                    break;
                default:
                    strokeWidth = 2;
                    strokeColor = "";
                    lineDash = "none";
                    break;
            }
            return { strokeWidth, strokeColor, lineDash };
        }
    
        function wrapText(text, width) {
            text.each(function() {
                const textElement = d3.select(this);
                const words = textElement.text().split(/\s+/).reverse();
                let word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1,
                    y = textElement.attr("y"),
                    dy = parseFloat(textElement.attr("dy") || 0),
                    tspan = textElement.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
    
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = textElement.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                    }
                }
            });
        }
    
        function filterAndUpdate() {
            const selectedStatus = d3.select("#statusFilter").property("value");
            const selectedKnowledge = d3.select("#knowledgeFilter").property("value");
            const selectedCapital = d3.select("#capitalFilter").property("value");
            const selectedLabor = d3.select("#laborFilter").property("value");
            const selectedNaturalResources = d3.select("#naturalResourcesFilter").property("value");
    
            let filteredNodes = nodesData;
    
            if (selectedStatus !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Status === selectedStatus);
            }
    
            if (selectedKnowledge !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Knowledge_Intensity === selectedKnowledge);
            }
    
            if (selectedCapital !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Capital_Intensity === selectedCapital);
            }
    
            if (selectedLabor !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Labor_Intensity === selectedLabor);
            }
    
            if (selectedNaturalResources !== "all") {
                filteredNodes = filteredNodes.filter(d => d.Natural_Resources_Intensity === selectedNaturalResources);
            }
    
            const remainingActivities = new Set(filteredNodes.map(node => node.Activity));
    
            let filteredEdges = edgesData.filter(edge => 
                remainingActivities.has(edge.Source) && remainingActivities.has(edge.Target)
            );
    
            const nodesWithEdges = new Set();
            filteredEdges.forEach(edge => {
                nodesWithEdges.add(edge.Source);
                nodesWithEdges.add(edge.Target);
            });
    
            filteredNodes = filteredNodes.filter(node => nodesWithEdges.has(node.Activity));
    
            renderChart(filteredNodes, filteredEdges);
        }
    
        function displayNodeDetails(nodeData) {
            const detailsTable = d3.select("#detailsTable");
            detailsTable.html("");
    
            const headers = Object.keys(nodeData);
            detailsTable.append("thead").append("tr")
                .selectAll("th")
                .data(headers)
                .enter()
                .append("th")
                .text(d => d);
    
            detailsTable.append("tbody").append("tr")
                .selectAll("td")
                .data(headers.map(header => nodeData[header]))
                .enter()
                .append("td")
                .text(d => d);
        }
    
        function getIntensityColor(value) {
            switch (value) {
                case "high":
                    return "#1f77b4";
                case "medium":
                    return "#ffdd57";
                case "low":
                    return "#d3d3d3";
                default:
                    return "#d3d3d3";
            }
        }
    
        function dragstarted(event, d) {
            d3.select(this).raise().attr("stroke", "black");
            d.originalX = x(d.Value_Chain_Position);
            d.originalY = y(d.Global_Competition_Intensity);
        }
    
        function dragged(event, d) {
            d3.select(this)
                .attr("transform", `translate(${event.x}, ${event.y})`);
        }
    
        function dragended(event, d) {
            d3.select(this)
                .transition()
                .duration(500)
                .attr("transform", `translate(${d.originalX}, ${d.originalY})`);
            d3.select(this).attr("stroke", null);
        }
    </script>
    
</body>
</html>
